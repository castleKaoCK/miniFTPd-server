# MiniFTP服务器

## 简介
MiniFTPd server 是一个基于Linux 平台的、应用层为FTP协议的、传输层为TCP协议的、仿vsftpd的服务器。

它可以与基于Windows 平台的LeapFTP 3.1.0客户端进行交互并收发文件。除此之外，它还实现了断点续传、空闲断开、限速下载、限制客户端数量等功能。

> 为了跟踪程序运行情况，将在终端产生大量输出。因此该提交版本将其实现为守护进程,不会在终端产生输出。

## 实现功能
- 与LeapFTP 客户端的交互格式为二进制格式。以字节流方式传输。
- 与LeapFTP 客户端进行字符串命令交互，解析客户端命令并回传对应的状态。
- 向客户端传送文件。根据客户端REST 命令及其后的参数，得到文件断点位置。从断点处传送。
- 从客户端接收文件。根据客户端REST 命令及其后的参数，得到文件断点位置。从断点处接收。
- 可读取配置文件信息。根据信息实现要求的功能。
- 设置定时器，规定时间内没有接收到客户端命令则产生中断并断开连接。
- 空闲断开。限速下载与上传。如果当前传输速度超过最大传输速度就让进程睡眠。
- 限制数量。建立哈希表，查询当前客户端数量和每IP连接数量。

## 系统设计
**1. 工作原理**

逻辑上建立两个TCP连接。

控制连接：两端是客户端协议解释器和服务器协议解释器。用来传输FTP命令。

数据连接：两端是用户数据传输进程和服务器数据传输进程。用来传输文件。 

**2. 客户端连接**

为每个客户端建立一个对应的nobody进程和服务进程（因为多线程和多路复用会共享各个连接的目录）。 

服务进程包含数据传输模块、FTP协议解析器、进程间通信模块。

nobody进程包含内部协议解析器、数据连接的建立、进程间通信模块。

**3. 工作模式**

- 主动模式（PORT）:

客户端向服务器发送PORT命令和一个（ip,port）对。

服务器以200响应。将客户端发过来的IP与端口暂存起来，以便后续建立数据连接。

客户端向服务器发送LIST命令。服务器检测在收到LIST命令之前是否接收过PORT或PASV命令，如果没有接收过，则响应425 Use PORT or PASV first。如果接收过，并且是PORT，则服务器创建数据套接字（bind 20 端口），调用connect主动连接客户端IP与端口，从而建立数据连接。

服务器发送150应答给客户端，表示准备就绪，可以开始传输。

开始传输列表。

服务器发送226应答给客户端，表示数据传输结束。传输结束，服务器主动关闭数据套接字。

- 被动模式（PASV）

客户端向服务器发送PASV命令。

服务器以227响应。服务器创建一个临时套接字在随机端口上监听，发送（ip,port）给客户端。

客户端向服务器发送LIST命令。服务器检测在收到LIST命令之前是否接收过PORT或PASV命令，如果没有接收过，则响应425 Use PORT or PASV first。如果接收过，并且是PASV，则调用accept被动接受客户端的连接，返回已连接套接字，从而建立了数据连接。

服务器发送150应答给客户端，表示准备就绪，可以开始传输。

开始传输列表。

服务器发送226应答给客户端，表示数据传输结束。传输结束，客户端主动关闭数据套接字。



## Build
```
$cd /miniftpd
$sudo bash
#make
```

